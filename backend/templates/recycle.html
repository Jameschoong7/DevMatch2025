<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>GreenChain - Recycle</title>
      <script type="module" src="{{ url_for('static', filename='main.js') }}"></script>
      <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <style>
            body {
                  background:beige;
                  min-height: 100vh;
            }
            .navbar {
                  background: rgba(255,255,255,0.95) !important;
                  backdrop-filter: blur(10px);
            }
            .main-content {
                  padding-top: 80px;
                  min-height: calc(100vh - 80px);
            }
            .recycle-card {
                  background: white;
                  border-radius: 20px;
                  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
                  padding: 30px;
                  margin: 20px 0;
            }
            #reader {
                  width: 100%;
                  max-width: 500px;
                  margin: 0 auto;
            }
            #result {
                  text-align: center;
                  margin: 20px 0;
            }
            .manual-input {
                  background: #f8f9fa;
                  border-radius: 15px;
                  padding: 20px;
                  margin: 20px 0;
            }
            .btn-recycle {
                  background: linear-gradient(45deg, #4CAF50, #45a049);
                  border: none;
                  border-radius: 25px;
                  padding: 10px 25px;
                  color: white;
                  font-weight: bold;
            }
            .wallet-info {
                  background: #e8f5e8;
                  border-radius: 10px;
                  padding: 15px;
                  margin-bottom: 20px;
            }
      </style>
</head>
<body>
      <!-- Navigation -->
      <nav class="navbar navbar-expand-lg navbar-light fixed-top">
            <div class="container">
                  <a class="navbar-brand" href="/">
                        <img src="{{ url_for('static', filename='greenchain.png') }}" alt="GreenChain" style="margin-right: 10px; width: 45px; height: 32px;">
                        GreenChain
                  </a>
                  <div class="navbar-nav ms-auto">
                        <!-- Wallet Connection Status -->
                        <div id="walletStatus" class="nav-item dropdown" style="display: none;">
                              <a class="nav-link dropdown-toggle" href="#" id="walletDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="https://img.icons8.com/color/20/000000/wallet.png" alt="Wallet" style="margin-right: 5px;">
                                    <span id="walletAddressShort">Connecting...</span>
                              </a>
                              <ul class="dropdown-menu" aria-labelledby="walletDropdown">
                                    <li><span class="dropdown-item-text">
                                          <strong>Wallet:</strong><br>
                                          <small id="walletAddressFull" class="text-muted"></small>
                                    </span></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="disconnectWallet()">
                                          <img src="{{ url_for('static', filename='logout.png') }}" alt="Logout" style="margin-right: 10px; width: 32px; height: 32px;">
                                          Disconnect Wallet
                                    </a></li>
                              </ul>
                        </div>
                        
                        <!-- Login Button -->
                        <div id="loginButton" class="nav-item">
                              <a class="nav-link" href="#" onclick="connectWallet()">
                                     <img src="{{ url_for('static', filename='user.png') }}" alt="Login" style="margin-right: 5px;width: 20px; height: 20px;">
                                    Connect Wallet
                              </a>
                        </div>
                        
                        <a class="nav-link active" href="/recycle">
                              <img src="{{ url_for('static', filename='triangular-arrows-sign-for-recycle.png') }}" alt="Recycle" style="margin-right: 5px; width: 20px; height: 20px;">
                              Recycle
                        </a>
                        <a class="nav-link" href="/donation">
                              <img src="{{ url_for('static', filename='donation.png') }}" alt="Donation" style="margin-right: 5px;width: 20px;height: 20px;">
                              Donation
                        </a>
                        <a class="nav-link" href="/ngo-transparency">
                              <img src="{{ url_for('static', filename='transparency.png') }}" alt="Transparency" style="margin-right: 5px;width: 20px;height: 20px;">
                              NGO Transparency
                        </a>
                  </div>
            </div>
      </nav>

      <div class="main-content">
            <div class="container">
                  <div class="row justify-content-center">
                        <div class="col-lg-8">
                              <div class="recycle-card">
                                    <div class="text-center mb-4">
                                          <img src="{{ url_for('static', filename='triangular-arrows-sign-for-recycle.png') }}" alt="Recycle" style="margin-right: 5px; width: 50px; height: 50px;">
                                          <h2>Recycle & Earn Tokens</h2>
                                          <p class="text-muted">Scan a QR code at the recycling center to earn tokens</p>
                                    </div>

                                    <!-- Wallet Info -->
                                    <div id="walletInfo" class="wallet-info" style="display: none;">
                                          <h5>
                                                <img src="https://img.icons8.com/color/20/000000/wallet.png" alt="Wallet" style="margin-right: 5px;">
                                                Connected Wallet
                                          </h5>
                                          <p id="walletAddress" class="mb-0"></p>
                                    </div>

                                    <!-- QR Scanner -->
                                    <div id="qr-section">
                                          <h4>
                                                <img src="https://img.icons8.com/color/24/000000/qr-code.png" alt="QR Code" style="margin-right: 8px;">
                                                Scan QR Code
                                          </h4>
                                         
                                          
                                          <div id="reader"></div>
                                          <div id="result"></div>
                                          
                                          <div class="text-center mt-3">
                                                <button onclick="resetScanner()" class="btn btn-secondary">
                                                      <img src="https://img.icons8.com/color/16/000000/refresh.png" alt="Reset" style="margin-right: 5px;">
                                                      Reset Scanner
                                                </button>
                                          </div>
                                    </div>

                                    <!-- Manual QR Input -->
                                    <div class="manual-input">
                                          <h5>
                                                <img src="https://img.icons8.com/color/20/000000/edit.png" alt="Manual" style="margin-right: 5px;">
                                                Manual QR Code Input
                                          </h5>
                                          <p>If camera scanning doesn't work, you can manually enter the QR code:</p>
                                          <div class="input-group mb-3">
                                                <input type="text" id="manualQrInput" class="form-control" placeholder="Enter QR code (e.g., greenchain-claim-abc12345)">
                                                <button class="btn btn-outline-primary" onclick="submitManualQr()">
                                                      <img src="https://img.icons8.com/color/16/000000/checkmark.png" alt="Submit" style="margin-right: 5px;">
                                                      Submit
                                                </button>
                                          </div>
                                         
                                    </div>

                                    <!-- Token Balance -->
                                    <div class="text-center mt-4">
                                          <h5>
                                                <img src="https://img.icons8.com/color/20/000000/wallet.png" alt="Balance" style="margin-right: 5px;">
                                                Your Token Balance
                                          </h5>
                                          <div id="token_balance" class="h4 text-success">Loading...</div>
                                          <button id="btnDisplayBalance" class="btn btn-recycle">
                                                <img src="https://img.icons8.com/color/16/000000/refresh.png" alt="Refresh" style="margin-right: 5px;">
                                                Refresh Balance
                                          </button>
                                    </div>

                                    <!-- Continue to Donation -->
                                    <div class="text-center mt-4">
                                          <a href="/donation" class="btn btn-success btn-lg">
                                                <img src="{{ url_for('static', filename='donation.png') }}" alt="Donation" style="margin-right: 5px;width: 20px;height: 20px;">
                                                Continue to Donation
                                          </a>
                                    </div>
                              </div>
                        </div>
                  </div>
            </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
      <script>
            // Check wallet connection on page load
            document.addEventListener('DOMContentLoaded', function() {
                  checkWalletConnection();
            });

            function checkWalletConnection() {
                  // Check if wallet is connected from localStorage
                  const savedWallet = localStorage.getItem('greenchain_wallet_address');
                  const isConnected = localStorage.getItem('greenchain_connected') === 'true';
                  
                  if (isConnected && savedWallet) {
                        updateWalletDisplay(savedWallet);
                  } else {
                        showLoginButton();
                  }
            }

            function updateWalletDisplay(walletAddress) {
                  const walletStatus = document.getElementById('walletStatus');
                  const loginButton = document.getElementById('loginButton');
                  const walletAddressShort = document.getElementById('walletAddressShort');
                  const walletAddressFull = document.getElementById('walletAddressFull');
                  
                  if (walletStatus && loginButton) {
                        walletStatus.style.display = 'block';
                        loginButton.style.display = 'none';
                        
                        // Display shortened wallet address
                        const shortAddress = walletAddress.substring(0, 6) + '...' + walletAddress.substring(walletAddress.length - 4);
                        walletAddressShort.textContent = shortAddress;
                        walletAddressFull.textContent = walletAddress;
                  }
            }

            function showLoginButton() {
                  const walletStatus = document.getElementById('walletStatus');
                  const loginButton = document.getElementById('loginButton');
                  
                  if (walletStatus && loginButton) {
                        walletStatus.style.display = 'none';
                        loginButton.style.display = 'block';
                  }
            }

            async function connectWallet() {
                  if (typeof window.ethereum === 'undefined') {
                        alert("Please install Metamask from https://metamask.io/");
                        return;
                  }

                  try {
                        // Request account access
                        await window.ethereum.request({ method: "eth_requestAccounts" });
                        
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        const signer = provider.getSigner();
                        const walletAddress = await signer.getAddress();
                        
                        // Save wallet connection to localStorage
                        localStorage.setItem('greenchain_wallet_address', walletAddress);
                        localStorage.setItem('greenchain_connected', 'true');
                        localStorage.setItem('greenchain_connection_time', Date.now().toString());
                        
                        // Update display
                        updateWalletDisplay(walletAddress);
                        
                        // Reload page to initialize QR scanner with connected wallet
                        location.reload();
                        
                  } catch (error) {
                        console.error("Connection error:", error);
                        alert("Failed to connect wallet");
                  }
            }

            function disconnectWallet() {
                  // Clear wallet connection from localStorage
                  localStorage.removeItem('greenchain_wallet_address');
                  localStorage.removeItem('greenchain_connected');
                  localStorage.removeItem('greenchain_connection_time');
                  
                  // Update display
                  showLoginButton();
                  
                  // Reload page to clear any wallet-dependent data
                  location.reload();
            }
      </script>
</body>
</html> 