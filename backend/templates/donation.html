<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>GreenChain - Donation</title>
      <script type="module" src="{{ url_for('static', filename='main.js') }}"></script>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <style>
            body {
                  background:beige;
                  min-height: 100vh;
            }
            .navbar {
                  background: rgba(255,255,255,0.95) !important;
                  backdrop-filter: blur(10px);
            }
            .main-content {
                  padding-top: 80px;
                  min-height: calc(100vh - 80px);
            }
            .donation-card {
                  background: white;
                  border-radius: 20px;
                  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
                  padding: 30px;
                  margin: 20px 0;
            }
            .btn-donate {
                  background: linear-gradient(45deg, #ff6b6b, #ee5a24);
                  border: none;
                  border-radius: 25px;
                  padding: 10px 25px;
                  color: white;
                  font-weight: bold;
            }
            .btn-convert {
                  background: linear-gradient(45deg, #4CAF50, #45a049);
                  border: none;
                  border-radius: 25px;
                  padding: 10px 25px;
                  color: white;
                  font-weight: bold;
            }
            .wallet-info {
                  background: #e8f5e8;
                  border-radius: 10px;
                  padding: 15px;
                  margin-bottom: 20px;
            }
            .balance-display {
                  background: #f8f9fa;
                  border-radius: 15px;
                  padding: 20px;
                  margin: 20px 0;
                  text-align: center;
            }
            .conversion-section {
                  background: #e8f5e8;
                  border-radius: 15px;
                  padding: 20px;
                  margin: 20px 0;
            }
            .donation-section {
                  background: #fff5f5;
                  border-radius: 15px;
                  padding: 20px;
                  margin: 20px 0;
            }
            .transaction-item {
                  background: #f8f9fa;
                  border-left: 4px solid #28a745;
                  padding: 15px;
                  margin: 10px 0;
                  border-radius: 8px;
                  transition: all 0.3s ease;
            }
            .transaction-item:hover {
                  transform: translateX(5px);
                  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            .transaction-type {
                  font-weight: bold;
                  color: #28a745;
            }
            .transaction-hash {
                  font-family: monospace;
                  font-size: 12px;
                  color: #6c757d;
                  word-break: break-all;
            }
            .blockchain-badge {
                  background: linear-gradient(45deg, #ff6b35, #f7931e);
                  color: white;
                  padding: 5px 10px;
                  border-radius: 15px;
                  font-size: 12px;
                  font-weight: bold;
            }
            .success-alert {
                  background: #d4edda;
                  border: 1px solid #c3e6cb;
                  border-radius: 10px;
                  padding: 15px;
                  margin: 15px 0;
                  color: #155724;
            }
            .form-group {
                  margin-bottom: 20px;
            }
            .form-group label {
                  font-weight: 600;
                  color: #333;
                  margin-bottom: 8px;
                  display: block;
            }
            .form-control {
                  border-radius: 10px;
                  border: 2px solid #e9ecef;
                  padding: 12px 15px;
                  transition: all 0.3s ease;
            }
            .form-control:focus {
                  border-color: #667eea;
                  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            }
      </style>
</head>
<body>
      <!-- Navigation -->
      <nav class="navbar navbar-expand-lg navbar-light fixed-top">
            <div class="container">
                  <a class="navbar-brand" href="/">
                        <img src="{{ url_for('static', filename='greenchain.png') }}" alt="GreenChain" style="margin-right: 10px; width: 45px; height: 32px;">
                        GreenChain
                  </a>
                  <div class="navbar-nav ms-auto">
                        <!-- Wallet Connection Status -->
                        <div id="walletStatus" class="nav-item dropdown" style="display: none;">
                              <a class="nav-link dropdown-toggle" href="#" id="walletDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="https://img.icons8.com/color/20/000000/wallet.png" alt="Wallet" style="margin-right: 5px;">
                                    <span id="walletAddressShort">Connecting...</span>
                              </a>
                              <ul class="dropdown-menu" aria-labelledby="walletDropdown">
                                    <li><span class="dropdown-item-text">
                                          <strong>Wallet:</strong><br>
                                          <small id="walletAddressFull" class="text-muted"></small>
                                    </span></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="disconnectWallet()">
                                          <img src="{{ url_for('static', filename='logout.png') }}" alt="Logout" style="margin-right: 10px; width: 32px; height: 32px;">
                                          Disconnect Wallet
                                    </a></li>
                              </ul>
                        </div>
                        
                        <!-- Login Button (shown when wallet not connected) -->
                        <div id="loginButton" class="nav-item">
                              <a class="nav-link" href="#" onclick="connectWallet()">
                                    <img src="https://img.icons8.com/color/20/000000/user.png" alt="Login" style="margin-right: 5px;">
                                    Connect Wallet
                              </a>
                        </div>
                        
                        <a class="nav-link" href="/recycle">
                              <img src="{{ url_for('static', filename='triangular-arrows-sign-for-recycle.png') }}" alt="Recycle" style="margin-right: 5px; width: 20px; height: 20px;">
                              Recycle
                        </a>
                        <a class="nav-link active" href="/donation">
                              <img src="{{ url_for('static', filename='donation.png') }}" alt="Donation" style="margin-right: 5px;width: 20px;height: 20px;">
                              Donation
                        </a>
                        <a class="nav-link" href="/ngo-transparency">
                              <img src="{{ url_for('static', filename='transparency.png') }}" alt="Transparency" style="margin-right: 5px;width: 20px;height: 20px;">
                              NGO Transparency
                        </a>
                  </div>
            </div>
      </nav>

      <div class="main-content">
            <div class="container">
                  <div class="row justify-content-center">
                        <div class="col-lg-8">
                              <div class="donation-card">
                                    <div class="text-center mb-4">
                                          <img src="{{ url_for('static', filename='donation.png') }}" alt="Donation" style="margin-right: 5px;width: 50px;height: 50px;">
                                          <h2>Convert Tokens & Donate</h2>
                                          <p class="text-muted">Convert your recycling tokens to donation credits and help NGOs</p>
                                          <span class="blockchain-badge">üîó All transactions recorded on blockchain</span>
                                    </div>

                                    <!-- Wallet Info -->
                                    <div id="walletInfo" class="wallet-info" style="display: none;">
                                          <h5>
                                                <img src="https://img.icons8.com/color/20/000000/wallet.png" alt="Wallet" style="margin-right: 5px;">
                                                Connected Wallet
                                          </h5>
                                          <p id="walletAddress" class="mb-0"></p>
                                    </div>

                                    <!-- Balance Display -->
                                    <div class="balance-display">
                                          <h5>
                                                <img src="https://img.icons8.com/color/20/000000/wallet.png" alt="Balance" style="margin-right: 5px;">
                                                Your Current Balance
                                          </h5>
                                          <div id="token_balance" class="h4 text-success">Loading...</div>
                                          <button id="btnDisplayBalance" class="btn btn-convert">
                                                <img src="https://img.icons8.com/color/16/000000/refresh.png" alt="Refresh" style="margin-right: 5px;">
                                                Refresh Balance
                                          </button>
                                    </div>

                                    <!-- Conversion Section -->
                                    <div class="conversion-section">
                                          <h4>
                                                <img src="https://img.icons8.com/color/24/000000/exchange.png" alt="Convert" style="margin-right: 8px;">
                                                Convert Tokens to Donation Credits
                                          </h4>
                                          <p class="text-muted">Convert your recycling tokens into donation credits that you can donate to NGOs. This transaction will be recorded on the blockchain.</p>
                                          
                                          <div class="row">
                                                <div class="col-md-8">
                                                      <div class="form-group">
                                                            <label for="tokenAmount">
                                                                  <img src="https://img.icons8.com/color/16/000000/coins.png" alt="Tokens" style="margin-right: 5px;">
                                                                  Number of tokens to convert:
                                                            </label>
                                                            <input type="number" id="tokenAmount" class="form-control" value="1" min="1">
                                                            <small class="text-muted">Available tokens: <span id="availableTokens">0</span></small>
                                                      </div>
                                                </div>
                                                <div class="col-md-4">
                                                      <button onclick="convertTokens()" class="btn btn-convert w-100 mt-4">
                                                            <img src="https://img.icons8.com/color/16/000000/exchange.png" alt="Convert" style="margin-right: 5px;">
                                                            Convert Tokens
                                                      </button>
                                                </div>
                                          </div>
                                    </div>

                                    <!-- Donation Section -->
                                    <div id="donation-section" class="donation-section" style="display: none;">
                                          <h4>
                                                <img src="{{ url_for('static', filename='donation.png') }}" alt="Donation" style="margin-right: 5px;width: 20px;height: 20px;">
                                                Donate to NGOs
                                          </h4>
                                          <p class="text-muted">Choose an NGO and donate your credits to make a positive impact. All donations are transparently recorded on the blockchain.</p>
                                          
                                          <div id="donation-options">
                                                <!-- Donation options will be loaded here when credits are available -->
                                          </div>
                                    </div>

                                  

                                    <!-- Back to Recycle -->
                                    <div class="text-center mt-4">
                                          <a href="/recycle" class="btn btn-secondary btn-lg">
                                                <img src="{{ url_for('static', filename='triangular-arrows-sign-for-recycle.png') }}" alt="Recycle" style="margin-right: 5px; width: 20px; height: 20px;">
                                                Back to Recycle
                                          </a>
                                    </div>
                              </div>
                        </div>
                  </div>
            </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
      <script>
            let currentWallet = null;
            let userTransactions = [];

            // Load user's transaction history on page load
            document.addEventListener('DOMContentLoaded', function() {
                  loadUserTransactions();
                  // Auto-refresh balance when page loads
                  setTimeout(() => {
                        loadUserBalance();
                  }, 500);
            });

            function loadUserBalance() {
                  if (!currentWallet) return;
                  
                  fetch(`/api/balance/${currentWallet}`)
                        .then(response => response.json())
                        .then(data => {
                              if (data.success) {
                                    document.getElementById('token_balance').textContent = `${data.token_balance} Tokens`;
                                    document.getElementById('availableTokens').textContent = data.token_balance;
                                    
                                    // Show donation section only if credits are available
                                    if (data.credits_balance > 0) {
                                          document.getElementById('donation-section').style.display = 'block';
                                          loadDonationOptions();
                                    } else {
                                          document.getElementById('donation-section').style.display = 'none';
                                    }
                              }
                        })
                        .catch(error => {
                              console.error('Error loading balance:', error);
                              document.getElementById('token_balance').textContent = 'Error loading balance';
                              document.getElementById('donation-section').style.display = 'none';
                        });
            }

            function loadUserTransactions() {
                  fetch('/api/transactions')
                        .then(response => response.json())
                        .then(data => {
                              if (data.success) {
                                    userTransactions = data.transactions;
                                    displayUserTransactions();
                              }
                        })
                        .catch(error => {
                              console.error('Error loading transactions:', error);
                        });
            }

            function displayUserTransactions() {
                  const container = document.getElementById('transaction-history');
                  
                  if (userTransactions.length === 0) {
                        container.innerHTML = `
                              <p class="text-muted">
                                    <img src="https://img.icons8.com/color/16/000000/info.png" alt="Info" style="margin-right: 5px;">
                                    No transactions yet. Start by converting your tokens!
                              </p>
                        `;
                        return;
                  }

                  // Filter transactions for current user (if wallet is connected)
                  let filteredTransactions = userTransactions;
                  if (currentWallet) {
                        filteredTransactions = userTransactions.filter(tx => 
                              tx.user && tx.user.toLowerCase() === currentWallet.toLowerCase()
                        );
                  }

                  if (filteredTransactions.length === 0) {
                        container.innerHTML = `
                              <p class="text-muted">
                                    <img src="https://img.icons8.com/color/16/000000/info.png" alt="Info" style="margin-right: 5px;">
                                    No transactions found for your wallet. Connect your wallet to see your history!
                              </p>
                        `;
                        return;
                  }

                  let html = '';
                  filteredTransactions.slice(0, 5).forEach(tx => {
                        const typeIcon = getTypeIcon(tx.type);
                        const typeColor = getTypeColor(tx.type);
                        
                        html += `
                              <div class="transaction-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                          <div class="flex-grow-1">
                                                <div class="transaction-type" style="color: ${typeColor}">
                                                      ${typeIcon} ${tx.type}
                                                </div>
                                                <div class="mt-2">${tx.description}</div>
                                                <div class="mt-2">
                                                      <small class="text-muted">
                                                            üìÖ ${tx.timestamp} | 
                                                            üî¢ Block #${tx.block_number}
                                                      </small>
                                                </div>
                                          </div>
                                    </div>
                                    <div class="transaction-hash mt-2">
                                          TX: ${tx.transaction_hash}
                                    </div>
                              </div>
                        `;
                  });
                  
                  container.innerHTML = html;
            }

            function getTypeIcon(type) {
                  const icons = {
                        'Token Claimed': 'ü™ô',
                        'Tokens Converted': 'üîÑ',
                        'Donation Made': '‚ù§Ô∏è',
                        'NGO Added': 'üè¢'
                  };
                  return icons[type] || 'üìù';
            }

            function getTypeColor(type) {
                  const colors = {
                        'Token Claimed': '#28a745',
                        'Tokens Converted': '#17a2b8',
                        'Donation Made': '#dc3545',
                        'NGO Added': '#6f42c1'
                  };
                  return colors[type] || '#6c757d';
            }

            function convertTokens() {
                  const amount = document.getElementById('tokenAmount').value;
                  const walletAddress = currentWallet || '0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6'; // Demo wallet
                  
                  if (!amount || amount <= 0) {
                        alert('Please enter a valid amount');
                        return;
                  }

                  // Show loading state
                  const convertBtn = event.target;
                  const originalText = convertBtn.innerHTML;
                  convertBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Converting...';
                  convertBtn.disabled = true;

                  fetch('/api/convert-tokens', {
                        method: 'POST',
                        headers: {
                              'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                              wallet_address: walletAddress,
                              amount: parseInt(amount)
                        })
                  })
                  .then(response => response.json())
                  .then(data => {
                        if (data.success) {
                              // Show success message
                              showSuccessMessage(`‚úÖ ${data.message} - Transaction recorded on blockchain!`);
                              
                              // Update balance display
                              document.getElementById('token_balance').textContent = `${data.new_token_balance} Tokens`;
                              document.getElementById('availableTokens').textContent = data.new_token_balance;
                              
                              // Show donation credits
                              document.getElementById('donation-section').style.display = 'block';
                              loadDonationOptions();
                              
                              // Refresh transaction history
                              setTimeout(() => {
                                    loadUserTransactions();
                              }, 1000);
                              
                              // Enable donation options
                              loadDonationOptions();
                        } else {
                              alert('Error: ' + data.error);
                        }
                  })
                  .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to convert tokens');
                  })
                  .finally(() => {
                        convertBtn.innerHTML = originalText;
                        convertBtn.disabled = false;
                  });
            }

            function showSuccessMessage(message) {
                  const alertDiv = document.createElement('div');
                  alertDiv.className = 'success-alert';
                  alertDiv.innerHTML = `
                        <strong>üéâ Success!</strong> ${message}
                        <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
                  `;
                  
                  const container = document.querySelector('.donation-card');
                  container.insertBefore(alertDiv, container.firstChild);
                  
                  // Auto-remove after 5 seconds
                  setTimeout(() => {
                        if (alertDiv.parentElement) {
                              alertDiv.remove();
                        }
                  }, 5000);
            }

            function loadDonationOptions() {
                  fetch('/api/ngos')
                        .then(response => response.json())
                        .then(data => {
                              const container = document.getElementById('donation-options');
                              
                              // First, get current credits balance
                              fetch(`/api/balance/${currentWallet || '0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6'}`)
                                    .then(balanceResponse => balanceResponse.json())
                                    .then(balanceData => {
                                          if (balanceData.success && balanceData.credits_balance > 0) {
                                                let html = `
                                                      <div class="alert alert-info mb-3">
                                                            <strong>üí∞ Donation Credits Available:</strong> ${balanceData.credits_balance} credits
                                                      </div>
                                                `;
                                                
                                                html += `
                                                      <div class="row">
                                                            <div class="col-md-6">
                                                                  <div class="form-group">
                                                                        <label for="ngoSelect">
                                                                              <img src="https://img.icons8.com/color/16/000000/organization.png" alt="NGO" style="margin-right: 5px;">
                                                                              Select NGO:
                                                                        </label>
                                                                        <select id="ngoSelect" class="form-control">
                                                                              <option value="">Choose an NGO...</option>
                                                `;
                                                
                                                data.ngos.forEach(ngo => {
                                                      html += `<option value="${ngo.address}">${ngo.name} (${ngo.address})</option>`;
                                                });
                                                
                                                html += `
                                                                        </select>
                                                                  </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                  <div class="form-group">
                                                                        <label for="donationAmount">
                                                                              <img src="https://img.icons8.com/color/16/000000/coins.png" alt="Amount" style="margin-right: 5px;">
                                                                              Donation amount (credits):
                                                                        </label>
                                                                        <input type="number" id="donationAmount" class="form-control" value="1" min="1" max="${balanceData.credits_balance}">
                                                                        <small class="text-muted">Available credits: ${balanceData.credits_balance}</small>
                                                                  </div>
                                                            </div>
                                                      </div>
                                                      <div class="row mt-3">
                                                            <div class="col-12 text-end">
                                                                  <button onclick="donateToNGO()" class="btn btn-donate">
                                                                        <img src="https://img.icons8.com/color/16/000000/donate.png" alt="Donate" style="margin-right: 5px;">
                                                                        Donate
                                                                  </button>
                                                            </div>
                                                      </div>
                                                `;
                                                
                                                container.innerHTML = html;
                                          } else {
                                                container.innerHTML = `
                                                      <div class="text-center">
                                                            <img src="https://img.icons8.com/color/48/000000/info.png" alt="Info" style="margin-bottom: 10px;">
                                                            <p class="text-muted">No donation credits available. Convert your tokens first to enable donation options.</p>
                                                      </div>
                                                `;
                                          }
                                    })
                                    .catch(error => {
                                          console.error('Error loading balance:', error);
                                          container.innerHTML = `
                                                <div class="text-center">
                                                      <img src="https://img.icons8.com/color/48/000000/info.png" alt="Info" style="margin-bottom: 10px;">
                                                      <p class="text-muted">Error loading balance. Please try again.</p>
                                                </div>
                                          `;
                                    });
                        })
                        .catch(error => {
                              console.error('Error loading NGOs:', error);
                              const container = document.getElementById('donation-options');
                              container.innerHTML = `
                                    <div class="text-center">
                                          <img src="https://img.icons8.com/color/48/000000/info.png" alt="Info" style="margin-bottom: 10px;">
                                          <p class="text-muted">Error loading NGOs. Please try again.</p>
                                    </div>
                              `;
                        });
            }

            function donateToNGO() {
                  const ngoSelect = document.getElementById('ngoSelect');
                  const donationAmount = document.getElementById('donationAmount');
                  
                  if (!ngoSelect || !donationAmount) {
                        alert('Please wait for the form to load.');
                        return;
                  }
                  
                  const ngoAddress = ngoSelect.value;
                  const amount = parseInt(donationAmount.value);
                  const walletAddress = currentWallet || '0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6';
                  
                  if (!ngoAddress) {
                        alert('Please select an NGO to donate to.');
                        return;
                  }
                  
                  if (!amount || amount <= 0) {
                        alert('Please enter a valid amount');
                        return;
                  }

                  // Show loading state
                  const donateBtn = document.querySelector('.donation-section .btn-donate');
                  const originalText = donateBtn.innerHTML;
                  donateBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Donating...';
                  donateBtn.disabled = true;

                  fetch('/api/donate', {
                        method: 'POST',
                        headers: {
                              'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                              wallet_address: walletAddress,
                              ngo_address: ngoAddress,
                              amount: amount
                        })
                  })
                  .then(response => response.json())
                  .then(data => {
                        if (data.success) {
                              showSuccessMessage(`‚ù§Ô∏è ${data.message} - Donation recorded on blockchain!`);
                              
                              // Update donation section based on remaining credits
                              if (data.new_credits_balance > 0) {
                                    // Refresh donation options with remaining credits
                                    loadDonationOptions();
                              } else {
                                    // Hide donation section if no credits remain
                                    document.getElementById('donation-section').style.display = 'none';
                              }
                              
                              // Refresh transaction history
                              setTimeout(() => {
                                    loadUserTransactions();
                              }, 1000);
                        } else {
                              alert('Error: ' + data.error);
                        }
                  })
                  .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to donate');
                  })
                  .finally(() => {
                        // Restore button state
                        if (donateBtn) {
                              donateBtn.innerHTML = originalText;
                              donateBtn.disabled = false;
                        }
                  });
            }
      </script>
      <script>
            // Check wallet connection on page load
            document.addEventListener('DOMContentLoaded', function() {
                  checkWalletConnection();
            });

            function checkWalletConnection() {
                  // Check if wallet is connected from localStorage
                  const savedWallet = localStorage.getItem('greenchain_wallet_address');
                  const isConnected = localStorage.getItem('greenchain_connected') === 'true';
                  
                  if (isConnected && savedWallet) {
                        updateWalletDisplay(savedWallet);
                        currentWallet = savedWallet;
                        loadUserBalance();
                        loadUserTransactions();
                  } else {
                        showLoginButton();
                  }
            }

            function updateWalletDisplay(walletAddress) {
                  const walletStatus = document.getElementById('walletStatus');
                  const loginButton = document.getElementById('loginButton');
                  const walletAddressShort = document.getElementById('walletAddressShort');
                  const walletAddressFull = document.getElementById('walletAddressFull');
                  
                  if (walletStatus && loginButton) {
                        walletStatus.style.display = 'block';
                        loginButton.style.display = 'none';
                        
                        // Display shortened wallet address
                        const shortAddress = walletAddress.substring(0, 6) + '...' + walletAddress.substring(walletAddress.length - 4);
                        walletAddressShort.textContent = shortAddress;
                        walletAddressFull.textContent = walletAddress;
                  }
            }

            function showLoginButton() {
                  const walletStatus = document.getElementById('walletStatus');
                  const loginButton = document.getElementById('loginButton');
                  
                  if (walletStatus && loginButton) {
                        walletStatus.style.display = 'none';
                        loginButton.style.display = 'block';
                  }
            }

            async function connectWallet() {
                  if (typeof window.ethereum === 'undefined') {
                        alert("Please install Metamask from https://metamask.io/");
                        return;
                  }

                  try {
                        // Request account access
                        await window.ethereum.request({ method: "eth_requestAccounts" });
                        
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        const signer = provider.getSigner();
                        const walletAddress = await signer.getAddress();
                        
                        // Save wallet connection to localStorage
                        localStorage.setItem('greenchain_wallet_address', walletAddress);
                        localStorage.setItem('greenchain_connected', 'true');
                        localStorage.setItem('greenchain_connection_time', Date.now().toString());
                        
                        // Update display and load data
                        updateWalletDisplay(walletAddress);
                        currentWallet = walletAddress;
                        loadUserBalance();
                        loadUserTransactions();
                        
                  } catch (error) {
                        console.error("Connection error:", error);
                        alert("Failed to connect wallet");
                  }
            }

            function disconnectWallet() {
                  // Clear wallet connection from localStorage
                  localStorage.removeItem('greenchain_wallet_address');
                  localStorage.removeItem('greenchain_connected');
                  localStorage.removeItem('greenchain_connection_time');
                  
                  // Update display
                  showLoginButton();
                  
                  // Clear current wallet
                  currentWallet = null;
                  
                  // Reload page to clear any wallet-dependent data
                  location.reload();
            }
      </script>
</body>
</html> 