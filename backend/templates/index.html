<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>GreenChain - Welcome</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <style>
            body {
                  background: beige;
                  min-height: 100vh;
            }
            .hero-section {
                  padding: 100px 0;
                  text-align: center;
                  color: black;
                  font-weight:bold;
            }
            .feature-card {
                  background: white;
                  border-radius: 20px;
                  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
                  padding: 30px;
                  margin: 20px 0;
                  text-align: center;
                  transition: transform 0.3s ease;
            }
            .feature-card:hover {
                  transform: translateY(-5px);
            }
            .btn-hero {
                  background: linear-gradient(45deg, #4CAF50, #45a049);
                  border: none;
                  border-radius: 25px;
                  padding: 15px 40px;
                  font-size: 18px;
                  font-weight: bold;
                  color: white;
                  margin: 10px;
                  transition: all 0.3s ease;
            }
            .btn-hero:hover {
                  transform: translateY(-2px);
                  box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
                  color: white;
            }
            .navbar {
                  background: rgba(255,255,255,0.95) !important;
                  backdrop-filter: blur(10px);
            }
            .transparency-section {
                  background: rgba(255,255,255,0.95);
                  border-radius: 20px;
                  padding: 30px;
                  margin: 30px 0;
            }
            .transaction-item {
                  background: #f8f9fa;
                  border-left: 4px solid #28a745;
                  padding: 15px;
                  margin: 10px 0;
                  border-radius: 8px;
                  transition: all 0.3s ease;
            }
            .transaction-item:hover {
                  transform: translateX(5px);
                  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            .transaction-type {
                  font-weight: bold;
                  color: #28a745;
            }
            .transaction-hash {
                  font-family: monospace;
                  font-size: 12px;
                  color: #6c757d;
                  word-break: break-all;
            }
            .stats-card {
                  background: linear-gradient(45deg, #28a745, #20c997);
                  color: white;
                  border-radius: 15px;
                  padding: 20px;
                  text-align: center;
                  margin: 10px 0;
            }
            .stats-number {
                  font-size: 2.5rem;
                  font-weight: bold;
            }
            .loading {
                  text-align: center;
                  padding: 20px;
                  color: #6c757d;
            }
            .blockchain-badge {
                  background: linear-gradient(45deg, #ff6b35, #f7931e);
                  color: white;
                  padding: 5px 10px;
                  border-radius: 15px;
                  font-size: 12px;
                  font-weight: bold;
            }
      </style>
</head>
<body>
      <!-- Navigation -->
      <nav class="navbar navbar-expand-lg navbar-light fixed-top">
            <div class="container">
                  <a class="navbar-brand" href="/">
                        <img src="{{ url_for('static', filename='greenchain.png') }}" alt="GreenChain" style="margin-right: 10px; width: 45px; height: 32px;">
                        GreenChain
                  </a>
                  <div class="navbar-nav ms-auto">
                        <!-- Wallet Connection Status -->
                        <div id="walletStatus" class="nav-item dropdown" style="display: none;">
                              <a class="nav-link dropdown-toggle" href="#" id="walletDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <img src="https://img.icons8.com/color/20/000000/wallet.png" alt="Wallet" style="margin-right: 5px;">
                                    <span id="walletAddressShort">Connecting...</span>
                              </a>
                              <ul class="dropdown-menu" aria-labelledby="walletDropdown">
                                    <li><span class="dropdown-item-text">
                                          <strong>Wallet:</strong><br>
                                          <small id="walletAddressFull" class="text-muted"></small>
                                    </span></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="disconnectWallet()">
                                          <img src="{{ url_for('static', filename='logout.png') }}" alt="Logout" style="margin-right: 10px; width: 32px; height: 32px;">
                                          Disconnect Wallet
                                    </a></li>
                              </ul>
                        </div>
                        
                        <!-- Login Button (shown when wallet not connected) -->
                        <div id="loginButton" class="nav-item">
                              <a class="nav-link" href="#" onclick="connectWallet()">
                                    <img src="{{ url_for('static', filename='user.png') }}" alt="Login" style="margin-right: 5px;width: 20px; height: 20px;">
                                    Connect Wallet
                              </a>
                        </div>
                        
                        <a class="nav-link" href="/recycle">
                              <img src="{{ url_for('static', filename='triangular-arrows-sign-for-recycle.png') }}" alt="Recycle" style="margin-right: 5px; width: 20px; height: 20px;">
                              Recycle
                        </a>
                        <a class="nav-link" href="/donation">
                              <img src="{{ url_for('static', filename='donation.png') }}" alt="Donation" style="margin-right: 5px;width: 20px; height: 20px;">
                              Donation
                        </a>
                        <a class="nav-link" href="/ngo-transparency">
                              <img src="{{ url_for('static', filename='transparency.png') }}" alt="Transparency" style="margin-right: 5px;width: 20px;height: 20px;">
                              NGO Transparency
                        </a>
                  </div>
            </div>
      </nav>

      <!-- Hero Section -->
      <div class="hero-section">
            <div class="container">
                  <div class="row justify-content-center">
                        <div class="col-lg-8">
                              <img src="{{ url_for('static', filename='greenchain.png') }}" alt="GreenChain Logo" style="margin-bottom: 30px; width: 150px; height: 120px;">
                              <h1 class="display-3 mb-4">Welcome to GreenChain</h1>
                              <p class="lead mb-5">Recycle, Earn Tokens, Donate to NGOs - Make the world greener, one recycle at a time!</p>
                              
                              <div class="mb-5">
                                    
                                    <a href="/recycle" class="btn btn-hero btn-outline-light">
                                          <img src="{{ url_for('static', filename='triangular-arrows-sign-for-recycle.png') }}" alt="Recycle" style="margin-right: 5px; width: 20px; height: 20px;">
                                          Start Recycling
                                    </a>
                              </div>
                        </div>
                  </div>
            </div>
      </div>

      <!-- Features Section -->
      <div class="container" style="padding-bottom: 50px;">
            <div class="row">
                  <div class="col-lg-4">
                        <div class="feature-card">
                               <img src="{{ url_for('static', filename='user.png') }}" alt="Recycle" style="margin-bottom: 20px; width: 64px; height: 64px;">
                              <h4>Step 1: Connect Wallet</h4>
                              <p class="text-muted">Connect your MetaMask wallet to start your recycling journey</p>
                             
                        </div>
                  </div>
                  
                  <div class="col-lg-4">
                        <div class="feature-card">
                              <img src="{{ url_for('static', filename='triangular-arrows-sign-for-recycle.png') }}" alt="Recycle" style="margin-bottom: 20px; width: 64px; height: 64px;">
                              <h4>Step 2: Recycle & Scan</h4>
                              <p class="text-muted">Scan QR codes at recycling centers to earn tokens for your efforts</p>
                              
                        </div>
                  </div>
                  
                  <div class="col-lg-4">
                        <div class="feature-card">
                              <img src="{{ url_for('static', filename='donation.png') }}" alt="Donation" style="margin-bottom:20px;width: 64px;height: 64px;">
                              <h4>Step 3: Convert & Donate</h4>
                              <p class="text-muted">Convert tokens to donation credits and help NGOs make a difference</p>
                             
                        </div>
                  </div>
            </div>
            
            <!-- How It Works -->
            <div class="row mt-5">
                  <div class="col-12">
                        <div class="feature-card">
                              <h3 class="mb-4">
                                    
                                    How It Works
                              </h3>
                              <div class="row">
                                    <div class="col-md-3">
                                          <div class="text-center">
                                                <img src="https://img.icons8.com/color/48/000000/qr-code.png" alt="QR Code" style="margin-bottom: 10px;">
                                                <h6>1. Scan QR Code</h6>
                                                <small class="text-muted">At recycling center</small>
                                          </div>
                                    </div>
                                    <div class="col-md-3">
                                          <div class="text-center">
                                                <img src="https://img.icons8.com/color/48/000000/coins.png" alt="Tokens" style="margin-bottom: 10px;">
                                                <h6>2. Earn Tokens</h6>
                                                <small class="text-muted">Get rewarded instantly</small>
                                          </div>
                                    </div>
                                    <div class="col-md-3">
                                          <div class="text-center">
                                                <img src="https://img.icons8.com/color/48/000000/exchange.png" alt="Convert" style="margin-bottom: 10px;">
                                                <h6>3. Convert Credits</h6>
                                                <small class="text-muted">Tokens to donation credits</small>
                                          </div>
                                    </div>
                                    <div class="col-md-3">
                                          <div class="text-center">
                                                <img src="{{ url_for('static', filename='donation.png') }}" alt="Donation" style="margin-bottom: 10px;width: 48px;height: 48px;">     
                                                <h6>4. Donate to NGOs</h6>
                                                <small class="text-muted">Make a positive impact</small>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>
            </div>

            <!-- Blockchain Transparency Section -->
            <div class="row mt-5">
                  <div class="col-12">
                        <div class="transparency-section">
                              <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h3>
                                          <img src="https://img.icons8.com/color/32/000000/blockchain-new-logo.png" alt="Blockchain" style="margin-right: 10px;">
                                           Transaction History
                                    </h3>
                                    <span class="blockchain-badge">Sepolia Testnet</span>
                              </div>
                              
                              <!-- Contract Statistics -->
                              <div class="row mb-4">
                                    <div class="col-md-3">
                                          <div class="stats-card">
                                                <div class="stats-number" id="total-recycling">-</div>
                                                <div>Recycling Events</div>
                                          </div>
                                    </div>
                                    <div class="col-md-3">
                                          <div class="stats-card">
                                                <div class="stats-number" id="total-conversions">-</div>
                                                <div>Token Conversions</div>
                                          </div>
                                    </div>
                                    <div class="col-md-3">
                                          <div class="stats-card">
                                                <div class="stats-number" id="total-donations">-</div>
                                                <div>Total Donations</div>
                                          </div>
                                    </div>
                                    <div class="col-md-3">
                                          <div class="stats-card">
                                                <div class="stats-number" id="contract-address">-</div>
                                                <div>Contract Address</div>
                                          </div>
                                    </div>
                              </div>

                              <!-- Live Transaction History -->
                              <h4 class="mb-3">
                                    <img src="https://img.icons8.com/color/24/000000/transaction-list.png" alt="Transactions" style="margin-right: 10px;">
                                     Live Transaction History
                              </h4>
                              
                              
                              <div id="transactions-container">
                                    <div class="loading">
                                          <div class="spinner-border text-success" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                          </div>
                                          <p class="mt-2">Loading blockchain transactions...</p>
                                    </div>
                              </div>

                              <div class="text-center mt-4">
                                    <button class="btn btn-outline-success" onclick="refreshTransactions()">
                                          <img src="https://img.icons8.com/color/16/000000/refresh.png" alt="Refresh" style="margin-right: 5px;">
                                          Refresh Transactions
                                    </button>
                              </div>
                        </div>
                  </div>
            </div>
      </div>

      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
      <script>
            // Load blockchain data on page load
            document.addEventListener('DOMContentLoaded', function() {
                  loadContractStats();
                  loadTransactions();
                  checkWalletConnection();
            });

            function checkWalletConnection() {
                  // Check if wallet is connected from localStorage
                  const savedWallet = localStorage.getItem('greenchain_wallet_address');
                  const isConnected = localStorage.getItem('greenchain_connected') === 'true';
                  
                  if (isConnected && savedWallet) {
                        updateWalletDisplay(savedWallet);
                  } else {
                        showLoginButton();
                  }
            }

            function updateWalletDisplay(walletAddress) {
                  const walletStatus = document.getElementById('walletStatus');
                  const loginButton = document.getElementById('loginButton');
                  const walletAddressShort = document.getElementById('walletAddressShort');
                  const walletAddressFull = document.getElementById('walletAddressFull');
                  
                  if (walletStatus && loginButton) {
                        walletStatus.style.display = 'block';
                        loginButton.style.display = 'none';
                        
                        // Display shortened wallet address
                        const shortAddress = walletAddress.substring(0, 6) + '...' + walletAddress.substring(walletAddress.length - 4);
                        walletAddressShort.textContent = shortAddress;
                        walletAddressFull.textContent = walletAddress;
                  }
            }

            function showLoginButton() {
                  const walletStatus = document.getElementById('walletStatus');
                  const loginButton = document.getElementById('loginButton');
                  
                  if (walletStatus && loginButton) {
                        walletStatus.style.display = 'none';
                        loginButton.style.display = 'block';
                  }
            }

            async function connectWallet() {
                  if (typeof window.ethereum === 'undefined') {
                        alert("Please install Metamask from https://metamask.io/");
                        return;
                  }

                  try {
                        // Request account access
                        await window.ethereum.request({ method: "eth_requestAccounts" });
                        
                        const provider = new ethers.providers.Web3Provider(window.ethereum);
                        const signer = provider.getSigner();
                        const walletAddress = await signer.getAddress();
                        
                        // Save wallet connection to localStorage
                        localStorage.setItem('greenchain_wallet_address', walletAddress);
                        localStorage.setItem('greenchain_connected', 'true');
                        localStorage.setItem('greenchain_connection_time', Date.now().toString());
                        
                        // Update display
                        updateWalletDisplay(walletAddress);
                        
                  } catch (error) {
                        console.error("Connection error:", error);
                        alert("Failed to connect wallet");
                  }
            }

            function disconnectWallet() {
                  // Clear wallet connection from localStorage
                  localStorage.removeItem('greenchain_wallet_address');
                  localStorage.removeItem('greenchain_connected');
                  localStorage.removeItem('greenchain_connection_time');
                  
                  // Update display
                  showLoginButton();
                  
                  // Reload page to clear any wallet-dependent data
                  location.reload();
            }

            function loadContractStats() {
                  fetch('/api/stats')
                        .then(response => response.json())
                        .then(data => {
                              if (data.success) {
                                    document.getElementById('total-recycling').textContent = data.stats.total_recycling_events;
                                    document.getElementById('total-conversions').textContent = data.stats.total_conversions;
                                    document.getElementById('total-donations').textContent = data.stats.total_donations;
                                    document.getElementById('contract-address').textContent = data.stats.contract_address.substring(0, 10) + '...';
                              }
                        })
                        .catch(error => {
                              console.error('Error loading stats:', error);
                        });
            }

            function loadTransactions() {
                  fetch('/api/transactions')
                        .then(response => response.json())
                        .then(data => {
                              if (data.success) {
                                    displayTransactions(data.transactions);
                              } else {
                                    document.getElementById('transactions-container').innerHTML = 
                                          '<div class="alert alert-warning">Failed to load transactions</div>';
                              }
                        })
                        .catch(error => {
                              console.error('Error loading transactions:', error);
                              document.getElementById('transactions-container').innerHTML = 
                                    '<div class="alert alert-warning">Failed to load transactions</div>';
                        });
            }

            function displayTransactions(transactions) {
                  const container = document.getElementById('transactions-container');
                  
                  if (transactions.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">No transactions found</div>';
                        return;
                  }

                  let html = '';
                  transactions.forEach(tx => {
                        const typeIcon = getTypeIcon(tx.type);
                        const typeColor = getTypeColor(tx.type);
                        
                        html += `
                              <div class="transaction-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                          <div class="flex-grow-1">
                                                <div class="transaction-type" style="color: ${typeColor}">
                                                      ${typeIcon} ${tx.type}
                                                </div>
                                                <div class="mt-2">${tx.description}</div>
                                                <div class="mt-2">
                                                      <small class="text-muted">
                                                            📅 ${tx.timestamp} | 
                                                            🔢 Block #${tx.block_number}
                                                      </small>
                                                </div>
                                          </div>
                                    </div>
                                    <div class="transaction-hash mt-2">
                                          TX: ${tx.transaction_hash}
                                    </div>
                              </div>
                        `;
                  });
                  
                  container.innerHTML = html;
            }

            function getTypeIcon(type) {
                  const icons = {
                        'Token Claimed': '🪙',
                        'Tokens Converted': '🔄',
                        'Donation Made': '❤️',
                        'NGO Added': '🏢'
                  };
                  return icons[type] || '📝';
            }

            function getTypeColor(type) {
                  const colors = {
                        'Token Claimed': '#28a745',
                        'Tokens Converted': '#17a2b8',
                        'Donation Made': '#dc3545',
                        'NGO Added': '#6f42c1'
                  };
                  return colors[type] || '#6c757d';
            }

            function refreshTransactions() {
                  document.getElementById('transactions-container').innerHTML = 
                        '<div class="loading"><div class="spinner-border text-success" role="status"></div><p class="mt-2">Refreshing...</p></div>';
                  loadTransactions();
            }
      </script>
</body>
</html> 